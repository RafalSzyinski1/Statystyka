---
title: "Statystyka"
author: "Rafał Szyiński, Kajetan Leszak"
date: "`r Sys.Date()`"
output: pdf_document
---

# Statystyka

## Wstęp

```{r libs}
library(ggplot2)
library(readr)
library(dplyr)
```

## Opis baza danych

- Baza pochodzi z eportal
- Baza danych składa się z ...
- Opis poszczególnych kolumn

```{r db_load}
data <- read.csv2("credit_card.xls");
```

## Wyliczenie podstawowych statystyk

Statysyka będzie wyliczona z columny items i spent

```{r summary_items_spent}
frame <- data.frame(
  items_summary=unclass(summary(data$items)),
  spent_summary=unclass(summary(data$spent))
  )
frame
```

## Wykresy

```{r plot_box}
ggplot() + 
  geom_bar(
    data=data, 
    aes(x=type_trans, y=items, color=gender, fill=gender), 
    stat="identity"
    ) +
  labs(
    title="Wykres słupkowy dla zakupu rodzaju dobra w zależności od płci",
    x="Rodzaj dobra",
    y="Sumaryczna ilość zakupionych produktów"
    ) +
  theme_classic()
```

```{r plot_linear}
# Filtrujemy wysztkie dane pierwszego użytkownika
user_data <- data[data$custid == "8257-BKBEDP-MRF",]

month_numeric <- c("January", "February", "March", "April","May", "June", "July", "August", "September", "October", "November", "December" )

# Zamiana miesiąca z słowa na liczbe np. January=1
month <- match(user_data$month, month_numeric)

user_date_spent = data.frame(
  year = user_data$year,
  month = month,
  spent = user_data$spent
  )

# Sortowanie po roku i miesiącu
sorted_user <- user_date_spent[order(user_date_spent$year, user_date_spent$month),]
# Sumaryczny wektor 
sorted_user$spent <- cumsum(sorted_user$spent)
data_length = length(sorted_user$spent)

ggplot() +
  geom_line(
    data=sorted_user, 
    aes(x = seq(from=1, to=data_length), y = spent),
    color = "chartreuse3",
    linewidth = 1
    ) + 
  scale_x_continuous(
    breaks= seq(from=1, to=data_length, by=5), 
    labels=c(paste(rep(2007, 12), month_numeric, sep="-"), paste(rep(2008, 12), month_numeric, sep="-"))
    ) +
  labs(
    title = "Wydatki użytkownika 8257-BKBEDP-MRF względem czasu",
    x = NULL,
    y = "Sumaryczne wydatki"
  ) +
  theme(axis.text.x = element_text(angle = 30, hjust = 0.5, vjust = 0.5))

```

```{r plot_histogram}

ggplot() +
  geom_histogram(
    data=data, 
    aes(x=card), 
    stat="count", 
    fill="lightblue") +
  labs(
    title = "Histogram typu używanych kart",
    x = "Typ karty",
    y = "Ilość użycia"
    ) +
  theme_minimal()

```

## Obserwacje odstające

Będziemy obserwować wydatki osób w zależności od ich wieku

### Przygotowanie danych

```{r data_prep}
user_data = 
  data.frame(year=data$birth_year, spent=data$spent) %>%
  group_by(year) %>% 
  summarize(
    total_spent=sum(spent),
    q1 = quantile(spent, 0.25),
    median = median(spent),
    q3 = quantile(spent, 0.75),
    lower_whisker = max(min(spent), q1 - 1.5 * (q3 - q1)),
    upper_whisker = min(max(spent), q3 + 1.5 * (q3 - q1)),
    mean = mean(spent),
    sd = sd(spent)
  )
```

### Wykres pudełko-wąsy

```{r values}
outliers_1929 <- data[data$birth_year == 1929,]$spent
outliers_1929 <- outliers_1929[outliers_1929 > user_data[user_data$year == 1929,]$upper_whisker]
outliers_1929
```

```{r plot_boxwhisker}
ggplot() +
  geom_boxplot(
    data=data, 
    aes(x=birth_year, y=spent, group=birth_year),
    color="cadetblue"
    ) +
  labs(
    title = "Wykres pudełko-wąsy dla wydatków w zależności od wieku osoby",
    x = "Rok urodzenia",
    y = "Wydaki",
    ) +
  theme_bw()
```

### Odchylenie standardowe

```{r values}
spent = data[data$birth_year == 1929,]$spent
data_1929 = user_data[user_data$year == 1929,]
norm <- dnorm(spent, data_1929$mean, data_1929$sd)
threashold <- data_1929$mean + 3 * data_1929$sd
outliers_1929 <- spent[spent > threashold]
outliers_1929
```

```{r plot_density}
ggplot() +
  geom_line(data=data.frame(x=spent, y=norm), aes(x, y)) +
  geom_point(data=data.frame(x=spent, y=norm), aes(x, y), color="red") + 
  geom_vline(xintercept=threashold) +
  labs(
    title = "Wykres gęstości wydatków ludzi urodzonych w 1929",
    x = "Wydatki",
    y = "Gęstość"
  ) +
  theme_minimal()
```

## Wyliczenie prawdopodobieństwa dla zmiennej

### Gerenowanie prób losowych

```{r random_sample}
x <- sort(data$birth_year)
mean_x <- mean(x)
sd_x <- sd(x)

continuous_dnorm <- dnorm(x, mean_x, sd_x)
continuous_pnorm <- pnorm(x, mean_x, sd_x)

discreet_dbinom <- dbinom(x, length(x), mean_x / length(x))
discreet_pbinom <- pbinom(x, length(x), mean_x / length(x))
```

### Obliczanie prawdopodobieńśtwa punktowego i przedziałowego

```{r probability}
x_point <- 1969
n <- last(which(x == x_point))
point <- continuous_dnorm[n]
interval <- continuous_pnorm[n]
point
interval
```

### Wykres ciągły

```{r continuous_probability_plot}
ggplot() +
  geom_line(data=data.frame(x=x, y=continuous_dnorm), aes(x, y)) +
  geom_polygon(
    data=data.frame(
      x=c(min(x), head(x, n), x_point), 
      y=c(0, head(continuous_dnorm, n), 0)), 
    aes(x, y),
    fill = "coral1"
    ) +
  labs(
    title = "Wykres gęstości roku urodzenia",
    subtitle = sprintf("Zaznaczono P(X >= %i)", x_point),
    x = "Rok urodzenia",
    y = "Gęstość"
  )

ggplot() + 
  geom_line(data=data.frame(x=x, y=continuous_pnorm), aes(x, y)) +
  geom_vline(xintercept = x_point, color="red") +
  labs(
    title = "Dystrybuanta roku urodzenia",
    subtitle = sprintf("Zaznaczono P(X >= %i)", x_point),
    x = "Rok urodzenia",
    y = "Wartość dystrybuanty"
  )
  
```

### Wykres dyskretny

```{r discreet_probability_plot}
ggplot() +
  geom_point(data=data.frame(x=x, y=discreet_dbinom), aes(x, y)) +
  labs(
    title = "Rozkład dyskretny funkcji gęstości dla roku urodzenia",
    x = "Rok urodzenia",
    y = "Gęstość"
  )
ggplot() + 
  geom_point(data=data.frame(x=x, y=discreet_pbinom), aes(x, y)) +
  labs(
    title = "Rozkład dyskretny dystrybuanty dla roku urodzenia",
    x = "Rok urodzenia",
    y = "Wartość dystrybuanty"
  )
```

## Macierz

```{r matrix}
matrix <- matrix(data$card_year) %>% cbind(data$items) %>% cbind(data$spent)

matrix_data = list(
  dimension = dim(matrix),
  number_of_row = nrow(matrix),
  number_of_colum = ncol(matrix),
  sum_of_columns = colSums(matrix),
  sum_of_first_two_row = rowSums(matrix[1:2,]),
  sum_of_all_elemets = sum(matrix))

matrix_data
```

## Przedziały ufności

### Zmienna numeryczna

```{r numeric_confidence_intervals}
x <- data$items
n <- length(x)
alpha <- 0.01
z <- qnorm(1 - alpha / 2)

x_mean <- mean(x)
x_sd <- sd(x)
x_dnorm <- dnorm(x, x_mean, x_sd)

lower_bound <- x_mean - (z * x_sd / sqrt(n))
upper_bound <- x_mean + (z * x_sd / sqrt(n))

lower_bound
upper_bound
```

### Zmienna jakościowa

Przedział ufności Walda

```{r qualitative_confidence_intervals}

cards_data <- data %>% group_by(card) %>% summarise(count = n())
n <- length(data$card)
p <- cards_data[cards_data$card == "Mastercard",]$count / n

alpha <- 0.001
z <- qnorm(1 - alpha / 2)

lower_bound <- p - z * sqrt(p * (1 - p) / n)
upper_bound <- p + z * sqrt(p * (1 - p) / n)

lower_bound
upper_bound
```

## Hipotezy

### Test parametryczny - średnia urodzenia to 1960

```{r a}
birth_year_data <- data$birth_year

t.test(birth_year_data, mu = 1960)
```
### Test parametryczny - ludzie urodzeni w 1960 wydają więcej niż ludzie urodzeni 1970

```{r b}
spent_1960 = data[data$birth_year == 1960,]$spent
spent_1970 = data[data$birth_year == 1970,]$spent

t.test(spent_1960, spent)
```
### Test nieparametryczny 1

### Test nieparamteryczny 2


## Regresja liniowa

### Przygotowanie danych

Powtórzony kod z wykresu liniowego

```{r data_prep}
user_data <- data[data$custid == "8257-BKBEDP-MRF",]

month_numeric <- c("January", "February", "March", "April","May", "June", "July", "August", "September", "October", "November", "December" )

month <- match(user_data$month, month_numeric)

user_date_spent = data.frame(
  year = user_data$year,
  month = month,
  spent = user_data$spent
  )

sorted_user <- user_date_spent[order(user_date_spent$year, user_date_spent$month),]
 
sorted_user$spent <- cumsum(sorted_user$spent)
data_length = length(sorted_user$spent)

# Obliczanie regresji liniowej
x <- seq(from=1, to=data_length)
model <- lm(sorted_user$spent ~ x)
y <- model$coefficients[2] * x + model$coefficients[1]
```

### Wykres

```{r plot_linear_regresion}
ggplot() +
  geom_point(
    data=sorted_user, 
    aes(x = seq(from=1, to=data_length), y = spent),
    size = 0.7
    ) +
  geom_line(
    data=data.frame(x=x, y=y), 
    aes(x = x, y = y),
    color = "blue"
    ) +
  scale_x_continuous(
    breaks= seq(from=1, to=data_length, by=5), 
    labels=c(paste(rep(2007, 12), month_numeric, sep="-"), paste(rep(2008, 12), month_numeric, sep="-"))
    ) +
  labs(
    title = "Wydatki użytkownika 8257-BKBEDP-MRF\nwzględem czasu (regresja liniowa)",
    subtitle = sprintf("A = %.02f, B = %.02f", model$coefficients[2], model$coefficients[1]),
    x = NULL,
    y = "Sumaryczne wydatki"
  ) +
  theme(axis.text.x = element_text(angle = 30, hjust = 0.5, vjust = 0.5))
```
